---
title: "1Time_for_warm_analysis.rmd, COSORE dataset - daytime as warm treatment"
output: html_document
---



```{r preliminaries, message=TRUE, include=FALSE, echo=FALSE}
# Set chunks defaults; these options will be applied to all subsequent chunks
knitr::opts_chunk$set(results = 'hide', message = TRUE, include = TRUE, echo = FALSE,
                      fig.height = 4.5, fig.width = 8, cache = T)

# Constants
OUTPUT_DIR		<- "outputs/"
SEPARATOR		<- "-------------------------------------------"
INFN 			<- "srdbv4/srdbv4.csv"
OUTFN 			<- "srdbv4_final.csv"
DATA_DIR <- 'other_data'
Global_PT_Del <- 'GlobalTempPrecipTimeSeries_Del.csv'
MGRsD_ALLData <- 'MGRsDAllData.csv'


# Create output and log folders if they do not exist
if(!file.exists(OUTPUT_DIR)) dir.create(OUTPUT_DIR)
if(!file.exists(LOG_DIR)) dir.create( LOG_DIR )

# install.packages('cowplot')
# Load required packages
library(cowplot)
library(data.table)
library(dplyr)
library(ggplot2)
theme_set(theme_bw())
library(lubridate)
library(kableExtra)
library(cowplot)
library(knitr)
library("ggpubr")
library(reshape)
# install.packages('Kendall')
library(zoo)
library(Kendall)

# library(cosore)
library(dplyr)
library(lubridate)

# Source all needed functions
source('functions.R')
```



```{r}
# input data
srdb_v4 <- read.csv(INFN, stringsAsFactors=F)
srdb_v4$Decades <- ifelse (srdb_v4$Year <= 2000, '1990s', '2010s')
srdb_v4$Q10_all <- coalesce(srdb_v4$Q10_0_10, srdb_v4$Q10_0_20, srdb_v4$Q10_5_15, srdb_v4$Q10_10_20, srdb_v4$Q10_other1, srdb_v4$Q10_other2)

PT_Del <- read.csv(paste0(DATA_DIR,'/', Global_PT_Del), header = T)
MGRsD <- read.csv(paste0(DATA_DIR, '/', MGRsD_ALLData), header = T)
MGRsD_obs_6 <- read.csv(paste0(DATA_DIR, '/', 'MGRsDObsLargerThan6_V3.CSV'), header = T)

longterm <- read.csv( paste0(DATA_DIR, '/', "LongTerm.csv"), header = T, row.names = 1, skip = 0 )
```


```{r}
# Read cosore dataset
cosore <- readRDS("other_data/cosore_data.RDS")
```


```{r}
# Data processing before Q10 calculation: some sites's year need change 
MGRsD_obs_6[MGRsD_obs_6$studynumber == 1971 & MGRsD_obs_6$Measure_Year==1998 , 'Measure_Year'] <- 1999
MGRsD_obs_6[MGRsD_obs_6$studynumber == 3619 & MGRsD_obs_6$Measure_Year==2000 , 'Measure_Year'] <- 2001
MGRsD_obs_6[MGRsD_obs_6$studynumber == 4234 & MGRsD_obs_6$Measure_Year==1998 , 'Measure_Year'] <- 1999
MGRsD_obs_6[MGRsD_obs_6$studynumber == 4234 & MGRsD_obs_6$Measure_Year==2005 , 'Measure_Year'] <- 2003
MGRsD_obs_6[MGRsD_obs_6$studynumber == 4234 & MGRsD_obs_6$Measure_Year==2004 , 'Measure_Year'] <- 2003
MGRsD_obs_6[MGRsD_obs_6$studynumber == 4234 & MGRsD_obs_6$Measure_Year==2001 , 'Measure_Year'] <- 2003
MGRsD_obs_6[MGRsD_obs_6$studynumber == 4015 , 'Measure_Year'] <- 2002
MGRsD_obs_6[MGRsD_obs_6$studynumber == 4270 & MGRsD_obs_6$Measure_Year==1998 , 'Measure_Year'] <- 1999
MGRsD_obs_6[MGRsD_obs_6$studynumber == 4270 & MGRsD_obs_6$Measure_Year==2001 , 'Measure_Year'] <- 2002
MGRsD_obs_6[MGRsD_obs_6$studynumber == 4270 & MGRsD_obs_6$Measure_Year==2004 , 'Measure_Year'] <- 2003
MGRsD_obs_6[MGRsD_obs_6$studynumber == 4270 & MGRsD_obs_6$Measure_Year==2005 , 'Measure_Year'] <- 2003
MGRsD_obs_6[MGRsD_obs_6$studynumber == 4477 , 'Measure_Year'] <- 2002
MGRsD_obs_6[MGRsD_obs_6$studynumber == 10002 , 'Measure_Year'] <- 1999
MGRsD_obs_6[MGRsD_obs_6$studynumber == 10035 , 'Measure_Year'] <- 2009
MGRsD_obs_6[MGRsD_obs_6$studynumber == 10106 , 'Measure_Year'] <- 2010
```


```{r, include=FALSE}
# DBefore Q10 calculation: check number of years of each site
MGRsD_obs_6 <- check_ID_year(MGRsD_obs_6)
```


```{r, results = 'hide', message = FALSE, include = FALSE}
# calculate Q10 by site of each year
MGRsD_Q10 <- Q10_cal(MGRsD_obs_6)
MGRsD_Q10 <- subset(MGRsD_Q10, MGRsD_Q10$Q10SY > 1 & MGRsD_Q10$Q10SY < 10)
MGRsD_Q10 <- subset(MGRsD_Q10, MGRsD_Q10$MiddleClimate != "A")
```



* We compared mean annual air temperature bwtween 1964 and 2000 (1990s) vs. mean air temperature between 2001 and 2017 (2000s)
* Air temperature of 1990s (1964-2000) are about 0.5 C lower than that from 2000s(2001-2017)
* In boreal and polar regions, the temperature difference is bigger (difference ~~ 1 C)
* Therefore, 1990s are treated as control, 2000s are treated as warming period

```{r}
# temperature of 1990s vs 2010s
ggplot(PT_Del, aes(Decades,  Tm)) +   
  geom_boxplot()+
  facet_wrap(~MiddleClimate, nrow = 2,scales = "free")+ 
  labs(y=expression("Air temperature "*"("*degree~C*")"))
```

```{r}
# plot Q10
MGRsD_Q10 <- MGRsD_Q10[MGRsD_Q10$Q10SY <= 10, ]
max(MGRsD_Q10$p_Q)
MGRsD_Q10 <- MGRsD_Q10[MGRsD_Q10$p_Q <= 0.1,]
MGRsD_Q10$Decades <- ifelse (MGRsD_Q10$studyYear <= 2000, '1990s', '2010s')
mean(MGRsD_Q10$Q10)
ggplot(data = MGRsD_Q10, aes(Q10SY)) + geom_histogram(fill = 'gray', col = 'black', binwidth = 0.25, alpha = 0.25)
```

* We used data from both srdb_v4 and MGRsD 

* For data from MGRsD, only sites with more than 7 months' Rs measurements were used
* For each sites, we simulate the ewlationshio between Rs and Tm (air temperature) with Rs=axexp^bxTm
* According to parameter b, we can calculate Q10=exp(b*10) 

* Q10 does not show a clear trend when changing from warm biome to cold biome (negative relationship between Q10 and annual mean temperature, Space for time)
* Q10 of 1990s does not signifficantly differ from Q10 of 2010s (Time for warming, panel b and d represent data from srdb_v4 and MGRsD respectively)

```{r, fig.width=8, fig.height=5}
plot_tfw_sft(srdb_v4, MGRsD_Q10)
```

* Why we see a clear Q10 decrease as annual temperature decrease, but cannot see the difference between 1990s and 2000s?
* (1) The temperature change is small, the soil respiration response (Q10) is too small to detect.
* (2) Hypothesis: some sites Q10 increase, site sites Q10 decrease, depend on ... ...
* As we seperate by biome region, we do see Q10 increased in arctic and boreal, but no change in other regions.
```{r, fig.height=7, fig.width=8}
# Q10 of 2010s and 1990s by biome 
srdb_Q10_biome(srdb_v4)
```

```{r}
biome_MLR_srdb (srdb_v4)
```


* Same results using data from MGRsD
* Using Rs data from MGRsD, we analyzed Rs vs. temperature in different biome for 1990s and 2000s
* How Rs response to temperature change does not shift in 2000s comparing to 1990s in most biome

```{r, fig.height=8, fig.width=8}

# use ggplot
p <- ggplot (MGRsD, aes(Tm, RsLog, colour = Decades))
p <- p + geom_point(alpha = 0.2, size = 1) + geom_smooth(method = 'lm') +
  facet_wrap(~MiddleClimate, ncol = 2) + 
  labs( y = expression(ln(Rs)~(g~C~m^{-2}~d^{-1} ))
       ,x = expression(Air~temperature~(degree~C) ) ) +
  theme(legend.position = 'top')
p

```

* using baysian approach?

```{r}
sum_MLR <- biome_MLR_MGRsD(MGRsD)
print(sum_MLR)
```

```{r}
# srdb_biome_comparisom (srdb_v4)
```



# Distribution of Q10 (not significant)

```{r}
ggplot(MGRsD_Q10, aes(Q10SY, color = (studyYear>2000), fill = (studyYear>2000)) ) + geom_density(stat = 'density', alpha = 0.25 ) +
    ggtitle('Q10 from MGRsD: 1990s vs 2000s') +
    xlab(expression(Q[10])) +
    theme(legend.position = c(0.75,0.65), legend.background = element_rect(colour = 'transparent', fill = alpha('white', 0), size = 0.75) )
```

```{r}
# plot by each biome
var_biome <- sort(unique(MGRsD_Q10$MiddleClimate))
for(i in 1:length(var_biome)) {
  MGRsD_Q10_biuome <- MGRsD_Q10[MGRsD_Q10$MiddleClimate == var_biome[i],]
  p <- ggplot(MGRsD_Q10_biuome, aes(Q10SY, color = (studyYear>2000), fill = (studyYear>2000)) ) + 
    geom_density(stat = 'density', alpha = 0.25 ) +
    ggtitle(var_biome[i]) +
    xlab(expression(Q[10])) +
    theme(legend.position = c(0.75,0.65), legend.background = element_rect(colour = 'transparent', fill = alpha('white', 0), size = 0.75))
  
  print(p)
  }

```


* Using SRDB_V4 (Q10 from soil temperature, Q10 are directly collected from publication)

```{r Q10 test, fig.height=6, fig.width=8}
# compare Q10 of 1961-1990 (30 years) vs 1991-2014
# colnames(srdb_v4)
Q10_1 <- Q10_early_late (srdb_v4, 'Q10_0_10', ' A (0-10 cm) ')
Q10_2 <- Q10_early_late (srdb_v4, 'Q10_5_15', ' B (5-15 cm) ')
Q10_3 <- Q10_early_late (srdb_v4, 'Q10_10_20', ' C (10-20 cm) ')
Q10_4 <- Q10_early_late (srdb_v4, 'Q10_0_20', ' D (0-20 cm) ')

plot_grid (Q10_1, Q10_2, Q10_3, Q10_4, ncol = 2)  

```

```{r R10 test}
# test Q10 under Ra and Rh dominant sites
R10_early_late (srdb_v4, 'R10', 'Test R10 for early and late years')

```


```{r}
# test Q10 by Biome
srdb_sub <- filtration (srdb_v4, 'Q10_0_10')
var_filt <- sort(unique(srdb_sub$Biome))
var_filt <- var_filt[c(-3, -4, -6)]
for (i in 1:length(var_filt)) {
  srdb_biome <- srdb_sub[srdb_sub$Biome == var_filt[i], ]
  Q10_1 <- Q10_early_late (srdb_biome, 'Q10_0_10', paste0(var_filt[i]," (0-10cm)"))
  print(Q10_1)
}
```



```{r}
# test R10 by biome
srdb_sub <- filtration (srdb_v4, 'R10')
var_filt <- sort(unique(srdb_sub$Biome))
# var_filt <- var_filt[c(-3, -4, -6)]
for (i in 1:length(var_filt)) {
  srdb_biome <- srdb_sub[srdb_sub$Biome == var_filt[i], ]
  R10_early_late (srdb_biome, 'R10', var_filt[i])
}
```



* Wether the Q10 response can be detected in site scale?
** using site scale long term Rs measurement (no experiment manipulation, i.e., only control used if have warming, N-addition, CO2 increasing)
** using results from Ben's AGU present results?

```{r, fig.height=3, fig.width=8}

# test first site
sub_longterm <- longterm[, 1] 
# plot rlling mean of 3 years 

x1 <- c(1:length(sub_longterm))
y1 <- sub_longterm

# plot raw data vs rolling mean data
sub_data <- data.frame(x1, y1)
raw_plot <- ggplot (aes(x1, y1),  data = sub_data) + geom_col() +
  scale_x_continuous(breaks = seq(0,25,5)) +
  labs(x = "Years after 1st Rs measurement", y = expression(Rs_annual~"("~g~C~m^{2}~yr^{-1}~")")) + 
  ggtitle ("(a) Raw data")


# roling mean by 3
rolingmean <- movingAverage (y1, 3)
sub_data <- data.frame(rolingmean[3:length(y1)], 1:length(rolingmean[3:length(y1)]) )
colnames(sub_data) <- c('y1', 'x1')

# lines(x1, rolingmean, col="green", lwd=2)
roling <- ggplot (aes(x1, y1),  data = sub_data) + geom_col() + 
  labs(x = "Years after 1st Rs measurement", y = expression(Rs_annual~"("~g~C~m^{2}~yr^{-1}~")")) +
  ggtitle("(b) Rolling mean of 3 yrs")

plot_grid(raw_plot, roling, ncol = 2, hjust = c(-3.25, -2.5), vjust = c(2.5, 2.5))
  
```



```{r, cache=TRUE}
# all 36 sites' average trend
# step 1: need scale data 
# maxs <- max( as.matrix(longterm), na.rm = T ) %>% rep(36)
# mins <- min( as.matrix(longterm), na.rm = T ) %>% rep(36)
# scaled <- as.data.frame(scale(longterm, center = mins, scale = maxs - mins))
# 
# # step 2: moving average
# out <- data.frame(rep(NA, 26))
# for(i in 1: ncol(scaled)) {
#   sub_data <- scaled[, i]
#   rolingmean <- movingAverage (sub_data, 3) %>% data.frame()
#   out <- bind_cols (out, rolingmean)
# }
# 
# out <- out[-1:-2, -1]
# colnames(out) <- colnames(longterm)
# 
# out$row_mean <- rowMeans(out, na.rm = TRUE, dims = 1)
# 
# roling <- ggplot (aes(1:24, row_mean),  data = out) + geom_col() + 
#   labs(x = "Years after 1st Rs measurement", y = expression(Rs_annual~"("~g~C~m^{2}~yr^{-1}~")")) +
#   ggtitle("Rolling mean of 3 yrs")
# 
# roling
```


* Each site (at least 5 years continous measurement), Mann-Kendall test was used to detect the trend change
* tau > 0 means increase trend, tau > 0.184 means significant increase trend
* tau < 0 means decrease trend, tau < -0.184 means significant decrease trenc
* the results show that overall, there are no trend (tau values not significantly differ from 0)
* also using long term SOC data do the same test?


```{r}
# Mann-Kendall test for each site and see whether the slope differ from 0
longtern_test(longterm)
# ncol(longterm)
```


* How soil respiration response to precipitation change?
* Q10 vs PDSI regression
* Results show that there are no singificant relationship between Q10 and drought (indentified by PDSI)

```{r}
Q10_pdsi(srdb_v4)
```

* Using SPI to detect temporal trend of precipitation?
* And then see whether Q10 values have relationship with SPI trend?
* Q10 vs SPI tau values ?
* First, need get global MK test and get tau value for each site
* Second, see how Q10 differ among different tau range () ?


* Using cosore data, daytime as warm and night time as control treatment ******************************************************

```{r }
tibble::glimpse(csr_table(cosore, "description"))
desc <- csr_table(cosore, "description")
var_dataset <- desc$CSR_DATASET
which(var_dataset=='d20190415_VARNER')
# ds <- cosore$d20190517_MAURITZ # nobs = 2 or 3 if use daily timescale
```

# `r ds$description$CSR_DATASET`

```{r}
# i=2, no CSR_T5 information, using TCHmber?
i = 9
var_dataset[i]
# ds <- cosore$d20190409_ANJILELI
# cosore[CSR_DATASET == 'd20190517_MAURITZ',]
ds <- cosore$d20190517_MAURITZ
tibble::glimpse(ds$description)
# d <- ds$description
# diag <- ds$diagnostics
```


## Site information

```{r map, echo=FALSE}
library(sp)
library(leaflet)
df <- data.frame(lon = ds$description$CSR_LONGITUDE, lat = ds$description$CSR_LATITUDE)
coordinates(df) <- ~lon + lat
leaflet(df) %>% 
  addMarkers() %>% 
  addTiles(options = providerTileOptions(minZoom = 3, maxZoom = 3))
```

## Reference information
## Contributors

```{r contrib_table, echo=FALSE}
knitr::kable(unlist(ds$contributors), format = "html", col.names = c("Value")) %>% 
  kableExtra::kable_styling(full_width = FALSE, position = "left")
```

## Measurement information

**Instrument**: `r d$CSR_INSTRUMENT`

**File format**: `r d$CSR_FILE_FORMAT`

**Timestamp format**: `r d$CSR_TIMESTAMP_FORMAT`

**Timestamp timezone**: `r d$CSR_TIMESTAMP_TZ`

```{r msmt_table, echo=FALSE}
knitr::kable(ds$ports, format = "html") %>% 
  kableExtra::kable_styling(full_width = FALSE, position = "left")
```

## Column mapping

```{r mapping, echo=FALSE}
knitr::kable(ds$columns, format = "html") %>% 
  kableExtra::kable_styling(full_width = FALSE, position = "left")
```


## Data processing diagnostics

Info                |  Value
------------------- | ----
Records             | `r diag$CSR_RECORDS`
Records removed (error)     | `r diag$CSR_RECORDS_REMOVED_ERR`
Records removed (invalid timestamp)     | `r diag$CSR_RECORDS_REMOVED_TIMESTAMP`
Records removed (no flux)   | `r diag$CSR_RECORDS_REMOVED_NA`
Records (flux < `r diag$CSR_FLUX_LOWBOUND`)  | `r diag$CSR_RECORDS_REMOVED_TOOLOW`
Records (flux > `r diag$CSR_FLUX_HIGHBOUND`) | `r diag$CSR_RECORDS_REMOVED_TOOHIGH`
Columns dropped     | `r diag$CSR_COLUMNS_DROPPED`
Bad `Tchamber` values removed | `r diag$CSR_BAD_TCHAMBER`
Size                | `r format(object.size(ds), "Mb")`

**Flux summary**:

```{r flux-graphs}
if(is.data.frame(ds$data) & !FALSE) {
  print(summary(ds$data$CSR_FLUX))
  
  dsd <- subset(ds$data, !is.na(CSR_FLUX) & CSR_FLUX > 0)
  
  # flux over time
  p1 <- ggplot(dsd, aes(CSR_TIMESTAMP, CSR_FLUX, color = CSR_PORT)) + 
    geom_line() + facet_grid(CSR_PORT~., scales = "free_y")
  print(p1)
  
  p2 <- ggplot(dsd, aes(CSR_TIMESTAMP, CSR_FLUX, color = CSR_PORT)) +
    geom_point(size = 0.2) + scale_y_log10()
  print(p2)
  
  dsd %>% 
    mutate(CSR_PORT = as.factor(CSR_PORT),
           Month = month(CSR_TIMESTAMP)) %>% 
    group_by(CSR_PORT, Month) %>% 
    summarise(CSR_FLUX = mean(CSR_FLUX)) %>% 
    ggplot(aes(Month, CSR_FLUX, color = CSR_PORT, group = CSR_PORT)) + 
    geom_line() ->
    p3
  print(p3)
  # histogram
  p4 <- ggplot(dsd, aes(x = CSR_FLUX)) + geom_histogram(bins = 30)
  print(p4)
}
```





```{r}
# using dsd data to test day and night Q10 (use one site as an example)
dsd %>% mutate(CSR_T5 = CSR_TCHAMBER,
               Year = year(CSR_TIMESTAMP),
               Month = month(CSR_TIMESTAMP),
               Day_range = case_when(
                 day(CSR_TIMESTAMP) %in% 1:5 ~ 1,
                 day(CSR_TIMESTAMP) %in% 6:10 ~ 2,
                 day(CSR_TIMESTAMP) %in% 11:15 ~ 3,
                 day(CSR_TIMESTAMP) %in% 16:20 ~ 4,
                 day(CSR_TIMESTAMP) %in% 21:25 ~ 5,
                 TRUE ~ 6
               ),
               Day = day(CSR_TIMESTAMP),
               Hour = hour(CSR_TIMESTAMP),
               DayNight = case_when (
                 hour(CSR_TIMESTAMP) >= 19 | hour(CSR_TIMESTAMP) <= 6 ~ "Night",
                 TRUE ~ "Day" ) ) %>% 
  # filter (!is.na(dsd$CSR_T5)) %>% 
  arrange(CSR_PORT,Year,Month,Day) -> dsd
dsd %>% filter (!is.na(dsd$CSR_T5)) -> dsd
```


```{r}
dsd %>% filter (Year == 2010 & Month == 3 & Day ==12 & CSR_PORT == 1 & DayNight == 'Day') %>% nrow()
dsd %>% filter (Year == 2016 & Month == 4 & Day_range ==5 & CSR_PORT == 0 & DayNight == 'Night') %>% nrow()
```


```{r, include=FALSE}
outputs_ds9 <- DN_Q10 (dsd, var_dataset = var_dataset[i])
```


```{r, fig.width=10, fig.height=4}
outputs <- outputs_ds9
outputs %>% filter(!is.na(Q10_day) & !is.na(Q10_night)) -> outputs
min(outputs$day_TS - outputs$night_TS)
max(outputs$day_TS - outputs$night_TS)
mean(outputs$day_TS - outputs$night_TS)
Q10_DN_Comp (outputs)
```


```{r}
# night as control and daytime as warm? Time for warm?
ggplot(outputs) + aes(day_TS - night_TS) + geom_histogram(col = "black", fill = "gray", bins = 30) +
  geom_vline(xintercept = c(quantile (outputs$day_TS - outputs$night_TS, c(0.025, 0.5, 0.975), na.rm = T)),col = "red", linetype = "dotted", size = 1.5) +
  facet_wrap(~var_month.j.) +
  xlab(expression("Day-night T"[S]~"("~degree~C~")"))

ggplot(outputs) + aes(x="all", y=(day_TS - night_TS)) + geom_violin(col = "black", fill = "white", bins = 30) +
  facet_wrap(~var_month.j.) +
  geom_jitter(shape=16, position=position_jitter(0.2), col = 'gray') +
  xlab(expression("Day-night T"[S]~"("~degree~C~")"))

ggplot(outputs) + aes(Q10_day-Q10_night) + geom_histogram(col = "black", fill = "gray", bins = 30) +
  geom_vline(xintercept = c(quantile (outputs$Q10_day - outputs$Q10_night, c(0.025, 0.5, 0.975), na.rm = T)),col = "red", linetype = "dotted", size = 1.5) +
  facet_wrap(~var_month.j.) +
  xlab(expression("Day-night Q"[10]))

ggplot(outputs) + aes(x="all", y=(Q10_day - Q10_night)) + geom_violin(col = "black", fill = "white", bins = 30) +
  facet_wrap(~var_month.j.) +
  geom_jitter(shape=16, position=position_jitter(0.2), col = 'gray') +
  xlab(expression("Day-night T"[S]~"("~degree~C~")"))
```

```{r}
min(outputs$day_TS - outputs$night_TS)
```


```{r}
# test the relationship between Q10 diff and TS differ
outputs %>% mutate(Q10diff = Q10_day - Q10_night,
                   STdiff = day_TS - night_TS) %>%
  filter (STdiff > 0.5) %>%
  ggplot() +
  aes(x = STdiff, y = Q10diff) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  xlab(expression("STday - STnight"~"("~degree~C~")")) +
  ylab(expression(dayQ[10]~"-"~nightQ[10]))

outputs %>% mutate(Q10diff = Q10_day - Q10_night,
                   STdiff = day_TS - night_TS) %>%
  filter (STdiff <= 0.5) %>%
  ggplot() +
  aes(x = STdiff, y = Q10diff) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  xlab(expression("STday - STnight"~"("~degree~C~")")) +
  ylab(expression(dayQ[10]~"-"~nightQ[10]))
```


```{r}
# test Q10 differ under different ST differ gradient
outputs %>% mutate(Q10diff = Q10_day - Q10_night,
                   STdiff = day_TS - night_TS,
                   STgradient = case_when ( STdiff < 0.5 ~ "G1",
                                            TRUE ~ "G2")
                   ) %>% ggplot () + aes(x=STgradient, y=(Q10diff)) +
  geom_violin(col = "black", fill = "white") +
  facet_wrap(~var_month.j.) +
  geom_jitter(shape=16, position=position_jitter(0.2), col = 'gray') +
  ylab(expression("Q"[10]~diff))
```

```{r}
# test whether SM5 differ in night and day time
# ggplot (dsd) + aes (x = DayNight, y = CSR_SM5) + 
#   geom_violin(col = "black", fill = "white") +
#   facet_wrap(~Month) +
#   # geom_jitter(shape=16, position=position_jitter(0.2), col = 'gray') +
#   ylab(expression(SM~"( % )"))
```
.
```{r}
# compare Rh and Rs: port 1, 3, 5, 7, 9 11, 13, 15 are root exclusion sites
# outputs %>% mutate(Q10diff = Q10_day - Q10_night,
#                    RhRs = case_when ( var_port.k. %in% c(1,3,5,7,9,11,13,15) ~ "Rh",
#                                             TRUE ~ "Rs")
#                    ) %>% ggplot () + aes(x=RhRs, y=(Q10diff)) +
#   geom_violin(col = "black", fill = "white") +
#   facet_wrap(~var_month.j.) +
#   geom_jitter(shape=16, position=position_jitter(0.2), col = 'gray') +
#   ylab(expression("Q"[10]~diff))
```

**Temperature sensitivity**:

```{r tsensitivity}
tcols <- grep("^CSR_T(CHAMBER|[0-9]+)", names(ds$data))
if(length(tcols)) {
  fluxcol <- grep("CSR_FLUX", names(ds$data))
  results <- list()
  for(col in tcols) {
    x <- ds$data[fluxcol]
    x$Temperature <- pull(ds$data, col)#ds$data[,col]
    x$Which_temp <- names(ds$data)[col]
    results[[as.character(col)]] <- x
  }
  results <- bind_rows(results)
  
  p1 <- ggplot(results, aes(Temperature, CSR_FLUX)) + 
    geom_point(size = 0.2, alpha = I(0.25)) + 
    geom_smooth(method = "lm") +
    facet_wrap(~Which_temp, scales = "free")
  print(p1)
}
```


