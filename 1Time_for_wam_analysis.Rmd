---
title: "1Time_for_warm_analysis.rmd"
output: html_document
---

```{r preliminaries, message=FALSE, include=FALSE, echo=FALSE}
# Set chunks defaults; these options will be applied to all subsequent chunks
knitr::opts_chunk$set(results = 'hide', message = TRUE, include = TRUE, echo = FALSE,
                      fig.height = 4.5, fig.width = 8)

# Constants
OUTPUT_DIR		<- "outputs/"
LOG_DIR			<- "logs/"
SEPARATOR		<- "-------------------------------------------"
INFN 			<- "srdbv4/srdbv4.csv"
OUTFN 			<- "srdbv4_final.csv"
DATA_DIR <- 'other_data'
Global_PT_Del <- 'GlobalTempPrecipTimeSeries_Del.csv'
MGRsD_ALLData <- 'MGRsDAllData.csv'


# Create output and log folders if they do not exist
if(!file.exists(OUTPUT_DIR)) dir.create(OUTPUT_DIR)
if(!file.exists(LOG_DIR)) dir.create( LOG_DIR )

# install.packages('cowplot')
# Load required packages
library(cowplot)
library(data.table)
library(dplyr)
library(ggplot2)
theme_set(theme_bw())
library(lubridate)
library(kableExtra)
library(cowplot)
library(knitr)
library("ggpubr")
library(reshape)
# install.packages('zoo')
library(zoo)
library(Kendall)

# Source all needed functions
source('functions.R')
```



```{r}
# input data
srdb_v4 <- read.csv(INFN, stringsAsFactors=F)
srdb_v4$Decades <- ifelse (srdb_v4$Year <= 2000, '1990s', '2010s')
srdb_v4$Q10_all <- coalesce(srdb_v4$Q10_0_10, srdb_v4$Q10_0_20, srdb_v4$Q10_5_15, srdb_v4$Q10_10_20, srdb_v4$Q10_other1, srdb_v4$Q10_other2)

PT_Del <- read.csv(paste0(DATA_DIR,'/', Global_PT_Del), header = T)
MGRsD <- read.csv(paste0(DATA_DIR, '/', MGRsD_ALLData), header = T)
MGRsD_obs_6 <- read.csv(paste0(DATA_DIR, '/', 'MGRsDObsLargerThan6_V3.CSV'), header = T)

longterm <- read.csv( paste0(DATA_DIR, '/', "LongTerm.csv"), header = T, row.names = 1, skip = 3 )
```



```{r}
# Data processing before Q10 calculation: some sites's year need change 
MGRsD_obs_6[MGRsD_obs_6$studynumber == 1971 & MGRsD_obs_6$Measure_Year==1998 , 'Measure_Year'] <- 1999
MGRsD_obs_6[MGRsD_obs_6$studynumber == 3619 & MGRsD_obs_6$Measure_Year==2000 , 'Measure_Year'] <- 2001
MGRsD_obs_6[MGRsD_obs_6$studynumber == 4234 & MGRsD_obs_6$Measure_Year==1998 , 'Measure_Year'] <- 1999
MGRsD_obs_6[MGRsD_obs_6$studynumber == 4234 & MGRsD_obs_6$Measure_Year==2005 , 'Measure_Year'] <- 2003
MGRsD_obs_6[MGRsD_obs_6$studynumber == 4234 & MGRsD_obs_6$Measure_Year==2004 , 'Measure_Year'] <- 2003
MGRsD_obs_6[MGRsD_obs_6$studynumber == 4234 & MGRsD_obs_6$Measure_Year==2001 , 'Measure_Year'] <- 2003
MGRsD_obs_6[MGRsD_obs_6$studynumber == 4015 , 'Measure_Year'] <- 2002
MGRsD_obs_6[MGRsD_obs_6$studynumber == 4270 & MGRsD_obs_6$Measure_Year==1998 , 'Measure_Year'] <- 1999
MGRsD_obs_6[MGRsD_obs_6$studynumber == 4270 & MGRsD_obs_6$Measure_Year==2001 , 'Measure_Year'] <- 2002
MGRsD_obs_6[MGRsD_obs_6$studynumber == 4270 & MGRsD_obs_6$Measure_Year==2004 , 'Measure_Year'] <- 2003
MGRsD_obs_6[MGRsD_obs_6$studynumber == 4270 & MGRsD_obs_6$Measure_Year==2005 , 'Measure_Year'] <- 2003
MGRsD_obs_6[MGRsD_obs_6$studynumber == 4477 , 'Measure_Year'] <- 2002
MGRsD_obs_6[MGRsD_obs_6$studynumber == 10002 , 'Measure_Year'] <- 1999
MGRsD_obs_6[MGRsD_obs_6$studynumber == 10035 , 'Measure_Year'] <- 2009
MGRsD_obs_6[MGRsD_obs_6$studynumber == 10106 , 'Measure_Year'] <- 2010
```


```{r, message=FALSE}
# DBefore Q10 calculation: check number of years of each site
MGRsD_obs_6 <- check_ID_year(MGRsD_obs_6)
```


```{r, results = 'hide', message = FALSE, include = FALSE}
# calculate Q10 by site of each year
MGRsD_Q10 <- Q10_cal(MGRsD_obs_6)
MGRsD_Q10 <- subset(MGRsD_Q10, MGRsD_Q10$Q10SY > 1 & MGRsD_Q10$Q10SY < 10)
MGRsD_Q10 <- subset(MGRsD_Q10, MGRsD_Q10$MiddleClimate != "A")
```



* We compared mean annual air temperature bwtween 1964 and 2000 (1990s) vs. mean air temperature between 2001 and 2017 (2000s)
* Air temperature of 1990s (1964-2000) are about 0.5 C lower than that from 2000s(2001-2017)
* In boreal and polar regions, the temperature difference is bigger (difference ~~ 1 C)
* Therefore, 1990s are treated as control, 2000s are treated as warming period

```{r}
# temperature of 1990s vs 2010s
ggplot(PT_Del, aes(Decades,  Tm)) +   
  geom_boxplot()+
  facet_wrap(~MiddleClimate, nrow = 2,scales = "free")+ 
  labs(y=expression("Air temperature "*"("*degree~C*")"))
```

```{r}
# plot Q10
MGRsD_Q10 <- MGRsD_Q10[MGRsD_Q10$Q10SY <= 10, ]
max(MGRsD_Q10$p_Q)
MGRsD_Q10 <- MGRsD_Q10[MGRsD_Q10$p_Q <= 0.1,]
MGRsD_Q10$Decades <- ifelse (MGRsD_Q10$studyYear <= 2000, '1990s', '2010s')
mean(MGRsD_Q10$Q10)
ggplot(data = MGRsD_Q10, aes(Q10SY)) + geom_histogram(fill = 'gray', col = 'black', binwidth = 0.25, alpha = 0.25)
```

* We used data from both srdb_v4 and MGRsD 

* For data from MGRsD, only sites with more than 7 months' Rs measurements were used
* For each sites, we simulate the ewlationshio between Rs and Tm (air temperature) with Rs=axexp^bxTm
* According to parameter b, we can calculate Q10=exp(b*10) 

* Q10 does not show a clear trend when changing from warm biome to cold biome (negative relationship between Q10 and annual mean temperature, Space for time)
* Q10 of 1990s does not signifficantly differ from Q10 of 2010s (Time for warming, panel b and d represent data from srdb_v4 and MGRsD respectively)

```{r, fig.width=8, fig.height=5}
plot_tfw_sft(srdb_v4, MGRsD_Q10)
```

* Why we see a clear Q10 decrease as annual temperature decrease, but cannot see the difference between 1990s and 2000s?
* (1) The temperature change is small, the soil respiration response (Q10) is too small to detect.
* (2) Hypothesis: some sites Q10 increase, site sites Q10 decrease, depend on ... ...
* As we seperate by biome region, we do see Q10 increased in arctic and boreal, but no change in other regions.
```{r, fig.height=7, fig.width=8}
# Q10 of 2010s and 1990s by biome 
srdb_Q10_biome(srdb_v4)
```

```{r}
biome_MLR_srdb (srdb_v4)
```


* Same results using data from MGRsD
* Using Rs data from MGRsD, we analyzed Rs vs. temperature in different biome for 1990s and 2000s
* How Rs response to temperature change does not shift in 2000s comparing to 1990s in most biome

```{r, fig.height=8, fig.width=8}

# use ggplot
p <- ggplot (MGRsD, aes(Tm, RsLog, colour = Decades))
p <- p + geom_point(alpha = 0.2, size = 1) + geom_smooth(method = 'lm') +
  facet_wrap(~MiddleClimate, ncol = 2) + 
  labs( y = expression(ln(Rs)~(g~C~m^{-2}~d^{-1} ))
       ,x = expression(Air~temperature~(degree~C) ) ) +
  theme(legend.position = 'top')
p

```

* using baysian approach?

```{r}
sum_MLR <- biome_MLR_MGRsD(MGRsD)
print(sum_MLR)
```

```{r}
# srdb_biome_comparisom (srdb_v4)
```



# Distribution of Q10 (not significant)

```{r}
ggplot(MGRsD_Q10, aes(Q10SY, color = (studyYear>2000), fill = (studyYear>2000)) ) + geom_density(stat = 'density', alpha = 0.25 ) +
    ggtitle('Q10 from MGRsD: 1990s vs 2000s') +
    xlab(expression(Q[10])) +
    theme(legend.position = c(0.75,0.65), legend.background = element_rect(colour = 'transparent', fill = alpha('white', 0), size = 0.75) )
```

```{r}
# plot by each biome
var_biome <- sort(unique(MGRsD_Q10$MiddleClimate))
for(i in 1:length(var_biome)) {
  MGRsD_Q10_biuome <- MGRsD_Q10[MGRsD_Q10$MiddleClimate == var_biome[i],]
  p <- ggplot(MGRsD_Q10_biuome, aes(Q10SY, color = (studyYear>2000), fill = (studyYear>2000)) ) + 
    geom_density(stat = 'density', alpha = 0.25 ) +
    ggtitle(var_biome[i]) +
    xlab(expression(Q[10])) +
    theme(legend.position = c(0.75,0.65), legend.background = element_rect(colour = 'transparent', fill = alpha('white', 0), size = 0.75))
  
  print(p)
  }

```


* Using SRDB_V4 (Q10 from soil temperature, Q10 are directly collected from publication)

```{r Q10 test, fig.height=6, fig.width=8}
# compare Q10 of 1961-1990 (30 years) vs 1991-2014
# colnames(srdb_v4)
Q10_1 <- Q10_early_late (srdb_v4, 'Q10_0_10', ' A (0-10 cm) ')
Q10_2 <- Q10_early_late (srdb_v4, 'Q10_5_15', ' B (5-15 cm) ')
Q10_3 <- Q10_early_late (srdb_v4, 'Q10_10_20', ' C (10-20 cm) ')
Q10_4 <- Q10_early_late (srdb_v4, 'Q10_0_20', ' D (0-20 cm) ')

plot_grid (Q10_1, Q10_2, Q10_3, Q10_4, ncol = 2)  

```

```{r R10 test}
# test Q10 under Ra and Rh dominant sites
R10_early_late (srdb_v4, 'R10', 'Test R10 for early and late years')

```


```{r}
# test Q10 by Biome
srdb_sub <- filtration (srdb_v4, 'Q10_0_10')
var_filt <- sort(unique(srdb_sub$Biome))
var_filt <- var_filt[c(-3, -4, -6)]
for (i in 1:length(var_filt)) {
  srdb_biome <- srdb_sub[srdb_sub$Biome == var_filt[i], ]
  Q10_1 <- Q10_early_late (srdb_biome, 'Q10_0_10', paste0(var_filt[i]," (0-10cm)"))
  print(Q10_1)
}
```



```{r}
# test R10 by biome
srdb_sub <- filtration (srdb_v4, 'R10')
var_filt <- sort(unique(srdb_sub$Biome))
# var_filt <- var_filt[c(-3, -4, -6)]
for (i in 1:length(var_filt)) {
  srdb_biome <- srdb_sub[srdb_sub$Biome == var_filt[i], ]
  R10_early_late (srdb_biome, 'R10', var_filt[i])
}
```



* Wether the Q10 response can be detected in site scale?
** using site scale long term Rs measurement (no experiment manipulation, i.e., only control used if have warming, N-addition, CO2 increasing)
** using results from Ben's AGU present results?

```{r, fig.height=3, fig.width=8}

# test first site
sub_longterm <- longterm[, 1] 
# plot rlling mean of 3 years 

x1 <- c(1:length(sub_longterm))
y1 <- sub_longterm

# plot raw data vs rolling mean data
sub_data <- data.frame(x1, y1)
raw_plot <- ggplot (aes(x1, y1),  data = sub_data) + geom_col() +
  scale_x_continuous(breaks = seq(0,25,5)) +
  labs(x = "Years after 1st Rs measurement", y = expression(Rs_annual~"("~g~C~m^{2}~yr^{-1}~")")) + 
  ggtitle ("(a) Raw data")


# roling mean by 3
rolingmean <- movingAverage (y1, 3)
sub_data <- data.frame(rolingmean[3:length(y1)], 1:length(rolingmean[3:length(y1)]) )
colnames(sub_data) <- c('y1', 'x1')

# lines(x1, rolingmean, col="green", lwd=2)
roling <- ggplot (aes(x1, y1),  data = sub_data) + geom_col() + 
  labs(x = "Years after 1st Rs measurement", y = expression(Rs_annual~"("~g~C~m^{2}~yr^{-1}~")")) +
  ggtitle("(b) Rolling mean of 3 yrs")

plot_grid(raw_plot, roling, ncol = 2, hjust = c(-3.25, -2.5), vjust = c(2.5, 2.5))
  
```



```{r}
# all 36 sites' average trend
# step 1: need scale data 
# maxs <- max( as.matrix(longterm), na.rm = T ) %>% rep(36)
# mins <- min( as.matrix(longterm), na.rm = T ) %>% rep(36)
# scaled <- as.data.frame(scale(longterm, center = mins, scale = maxs - mins))
# 
# # step 2: moving average
# out <- data.frame(rep(NA, 26))
# for(i in 1: ncol(scaled)) {
#   sub_data <- scaled[, i]
#   rolingmean <- movingAverage (sub_data, 3) %>% data.frame()
#   out <- bind_cols (out, rolingmean)
# }
# 
# out <- out[-1:-2, -1]
# colnames(out) <- colnames(longterm)
# 
# out$row_mean <- rowMeans(out, na.rm = TRUE, dims = 1)
# 
# roling <- ggplot (aes(1:24, row_mean),  data = out) + geom_col() + 
#   labs(x = "Years after 1st Rs measurement", y = expression(Rs_annual~"("~g~C~m^{2}~yr^{-1}~")")) +
#   ggtitle("Rolling mean of 3 yrs")
# 
# roling
```


* Each site (at least 5 years continous measurement), Mann-Kendall test was used to detect the trend change
* tau > 0 means increase trend, tau > 0.184 means significant increase trend
* tau < 0 means decrease trend, tau < -0.184 means significant decrease trenc
* the results show that overall, there are no trend (tau values not significantly differ from 0)
* also using long term SOC data do the same test?


```{r}
# Mann-Kendall test for each site and see whether the slope differ from 0
longtern_test(longterm)
```


* How soil respiration response to precipitation change?
* Q10 vs PDSI regression
* Results show that there are no singificant relationship between Q10 and drought (indentified by PDSI)

```{r}
Q10_pdsi(srdb_v4)
```

* Using SPI to detect temporal trend of precipitation?
* And then see whether Q10 values have relationship with SPI trend?
* Q10 vs SPI tau values ?
* First, need get global MK test and get tau value for each site
* Second, see how Q10 differ among different tau range ()
